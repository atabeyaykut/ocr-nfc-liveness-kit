// React Native Android app module build configuration (RN 0.74+ compatible)
// This file defines debug and release buildTypes and a sample signingConfig

plugins {
  id 'com.android.application'
  id 'jacoco'
}

android {
  namespace "com.ocrmobilesdk"
  compileSdkVersion 34
  ndkVersion "25.1.8937393"

  defaultConfig {
    applicationId "com.ocrmobilesdk"
    minSdkVersion rootProject.ext.minSdkVersion
    targetSdkVersion 34
    versionCode 1
    versionName "1.0.0"
    multiDexEnabled true
    
    // React Native BuildConfig fields
    buildConfigField "boolean", "IS_NEW_ARCHITECTURE_ENABLED", "false"
    buildConfigField "boolean", "IS_HERMES_ENABLED", "true"
  }

  buildFeatures {
    buildConfig true  // Enable BuildConfig generation
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }

  // Java toolchain for CI/CD compatibility
  java {
    toolchain {
      languageVersion = JavaLanguageVersion.of(17)
    }
  }

  // Manual React Native configuration (without plugin)
  project.ext.react = [
    enableHermes: true,
    bundleInDebug: false,
    bundleInRelease: true,
    devDisabledInDebug: true,
    entryFile: "index.js",
    root: "../../"
  ]

  def keystorePropertiesFile = rootProject.file("keystore.properties")
  def keystoreProperties = new Properties()
  if (keystorePropertiesFile.exists()) {
      keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
  }

  signingConfigs {
    debug {
      // Debug keystore is automatically provided by the Android SDK
    }
    release {
        def storeFilePath = keystoreProperties['STORE_FILE'] ?: 'ocr-release-key.keystore'
        storeFile rootProject.file(storeFilePath)
        storePassword keystoreProperties['STORE_PASSWORD'] ?: System.getenv("RELEASE_STORE_PASSWORD")
        keyAlias keystoreProperties['KEY_ALIAS'] ?: 'ocr-key-alias'
        keyPassword keystoreProperties['KEY_PASSWORD'] ?: System.getenv("RELEASE_KEY_PASSWORD")
    }
  }

  buildTypes {
    debug {
      applicationIdSuffix ".debug"
      versionNameSuffix "-debug"
      debuggable true
      signingConfig signingConfigs.debug
    }
    release {
        signingConfig signingConfigs.release
        minifyEnabled true
        shrinkResources true
        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
  }

  // Generate separate APKs per CPU architecture (optional)
  splits {
    abi {
      enable true
      reset()
      include 'armeabi-v7a', 'arm64-v8a', 'x86', 'x86_64'
      universalApk true
    }
  }

  packagingOptions {
    resources {
      excludes += [
        'META-INF/LICENSE*',
        'META-INF/DEPENDENCIES',
        'META-INF/NOTICE*'
      ]
    }
  }
}



dependencies {
  // React Native core (required for bridge functionality)
  implementation "com.facebook.react:react-android"
  implementation "com.facebook.react:react-native"
  implementation "com.facebook.react:hermes-android"

  // Add AndroidX AppCompat (commonly needed by RN libs)
  implementation "androidx.appcompat:appcompat:1.7.0"
  implementation "com.google.android.material:material:1.12.0"
  
  // Multidex support for large applications
  implementation "androidx.multidex:multidex:2.0.1"
  
  // BouncyCastle for cryptography (NFC signature validation)
  implementation "org.bouncycastle:bcprov-jdk18on:1.78"
  implementation "org.bouncycastle:bcpkix-jdk18on:1.78"
  
  // OkHttp3 for secure networking with certificate pinning
  implementation "com.squareup.okhttp3:okhttp:4.12.0"

  // Security crypto for EncryptedSharedPreferences
  implementation "androidx.security:security-crypto:1.1.0-alpha06"
  
  // Gson for JSON serialization
  implementation "com.google.code.gson:gson:2.10.1"
  
  // CameraX for ImageProxy (güncel sürümler)
  implementation "androidx.camera:camera-core:1.3.4"
  implementation "androidx.camera:camera-camera2:1.3.4"
  implementation "androidx.camera:camera-lifecycle:1.3.4"
  
  // React Native NFC Manager dependencies
  implementation "com.google.android.gms:play-services-nfc:18.5.0"
  
  // Test dependencies
  testImplementation "junit:junit:4.13.2"
  testImplementation "org.mockito:mockito-core:5.12.0"
  testImplementation "org.robolectric:robolectric:4.13"
  testImplementation "androidx.test:core:1.6.1"
  testImplementation "androidx.test.ext:junit:1.2.1"
}

// React Native manual configuration (simplified)

// JaCoCo test coverage configuration
jacoco {
  toolVersion = "0.8.10"
}

tasks.withType(Test) {
  jacoco.includeNoLocationClasses = true
  jacoco.excludes = ['jdk.internal.*']
}

task jacocoTestReport(type: JacocoReport, dependsOn: ['testDebugUnitTest']) {
  reports {
    xml.required = true
    html.required = true
  }

  def fileFilter = [
    '**/R.class',
    '**/R$*.class',
    '**/BuildConfig.*',
    '**/Manifest*.*',
    '**/*Test*.*',
    'android/**/*.*'
  ]

  def debugTree = fileTree(dir: "${buildDir}/intermediates/javac/debug", excludes: fileFilter)
  def mainSrc = "${project.projectDir}/src/main/java"

  sourceDirectories.setFrom(files([mainSrc]))
  classDirectories.setFrom(files([debugTree]))
  executionData.setFrom(fileTree(dir: "${buildDir}", includes: [
    'jacoco/testDebugUnitTest.exec',
    'outputs/code_coverage/debugAndroidTest/connected/**/*.ec'
  ]))
}
